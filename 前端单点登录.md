目前公司前端站点有 友金所、友金服、友金社、移动官网，而四个站点的域名均不相同，为了让用户有更好的体验，我们期望用户在某一站点登录后，在进入其他站点时不需要再重复进行登录，而这一过程便是单点登录。

所以单点登录所要实现的就是，某一站点登录后，将其登录态会同步到其他另外几个站点。

我们分两部分，先说单个站点的登录流程，在说同步登录态的流程，以友金所和友金服作为例子。

### 登录流程
有个小前提，我们是采用 `cookies` 来作为客户端的登录态凭证，redis 用于状态共享
友金服站点的登录流程

1. node端（简称服务端）调用用户模块接口 `/user/login`，用户模块登录成功后，返回 `token` 和其他用户信息，其中 `token` 就是用户的登录的凭证，在用户模块中是缓存该用户信息的 `key`
2. 登录成功后设置 `cookies` ，我们将设置两条 `cookies`， `oldSevSessionKey` 是旧官网的 key，主要为了兼容旧官网的页面， `sessionGlobalKey` 是当前站点友金服的 `key` ， `value` 就是用户模块返回的 `token`
```javascript
ctx.cookies.set(ctx.app.config.msv.oldSevSessionKey, value, option);
ctx.cookies.set(ctx.app.config.sessionGlobalKey, value, option);
```
3. 将用户模块返回的用户相关信息写入 `redis` 缓存中，目前已封装好基于 `redis` 的 `session` 对象，
```javascript
ctx.session.userInfo = Object.assign({}, userInfo);
```
session对象修改的同时，会写入 `cookie` ，其中 `key` 为约定好的 `sessionKey` ， `value` 是由uuid生成的随机字符串，这条cookie便是用户的唯一凭证
4. 给客户端返回 `ticket` `，ticket` 生成算法如下 `AESHelper.encrypt(ctx.sessionId + '&' + (ctx.cookies.get(ctx.sessionKey + '.sig') || ''));`
5. 给客户端返回 `clients` 数组，该值在配置中心进行配置，该数组后续会解释

按照上述流程登录后，在浏览器控制台可看到
![application](/image/login/application.png)
- yyfax.key 用于存储用户模块的token
- yyfax.sess 用于存储服务端session的key
- yyfax.sess.sig 对yyfax.sess加密的值

在 `redis` 查找 `key` 等于 `yyfax.sess` 的值，如下图
![redis](/image/login/redis.png)

所以站点的登录态是由浏览器 `cookie` 和 服务端 `session（redis）` 共同维系的。

### 同步登录态
既然已经明确登录态是由 `cookie` 和 `session` 决定的，而 cookie 又是由 session 写入的，那么也就是说，只要把 session 同步到其它站点，其它站点便有了自己的域名下的 cookie 和 session ，两个不用域名下的站点变有相同的登录信息了。

因此，同步登录态就转变成如何同步 `session` 的问题。

我们的策略是，在A站点登录成功后，调用B站点的接口，将A站点的 sessionKey 传过去，B站点根据sessionKey从缓存中获取用户信息，然后写入自己的session中，当用户访问B站点时，B站点将自己的 sessionKey 写入cookie，到此，B站点变拥有了自己的登录态。

我们先做如下约定：
1. 约定同步session的接口，大家还记得登录完成后，返回给前端的 clients 数组么？没错，这个数组就是约定好的接口地址。
- 友金所和友金社的同步接口地址是 /user/backGroundImageActive/
- 友金服的同步接口地址是 user.do?fn=ssoAsyncStatus
2. sessionKey 可以从登录接口返回的ticket，解密后便可获取到

同步步骤如下
1. 在友金服站点登录成功后，调用 clients 数组中的接口，并将 ticket 作为参数
2. 在友金所的同步接口中，将 ticket 解密后可得到的 sessionKey
3. 根据 sessionKey 便可以在redis中查询到友金服写入的用户信息和token
4. 将获取到的用户信息写到自己的 session 对象中，并同步到该服务下的缓存空间中

### 流程图

![tu](/image/login/tu.png)

### 移动端登录态同步
因为友金服移动站点的域名是 www.m.yyfax.com 是属于 www.yyfax.com 的子域名，所以 www.m.yyfax.com 该站点是无法访问到如下的 cookie 的
![cookie](/image/login/cookie.png)

因此为了让移动站点和PC站点能够互享 cookie ，可将 Domain 设置成通配符 `.yyfax.com` ，具体设置如下

```javascript
ctx.cookieOption = { ...CONFIG.cookie, domain: app.config.domain };
```


